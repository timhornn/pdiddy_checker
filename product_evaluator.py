import os
import logging
import telebot
from product_evaluator import ProductEvaluator

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ—Ü–µ–Ω—â–∏–∫–∞
evaluator = ProductEvaluator()

# –°–æ–∑–¥–∞–Ω–∏–µ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ –±–æ—Ç–∞
bot = telebot.TeleBot("8302560859:AAEhaZx1O_s3iIg8lZCfM6e8noxJeXp01ns")

# –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram
MAX_MESSAGE_LENGTH = 4000  # –ù–µ–º–Ω–æ–≥–æ –º–µ–Ω—å—à–µ 4096 –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏


# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start
@bot.message_handler(commands=['start', 'help'])
def send_welcome(message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start"""
    welcome_message = (
        "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ PDiddy checker!\n\n"
        "–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é —ç—Ç–∏–∫–µ—Ç–∫–∏ –¥–µ—Ç—Å–∫–æ–≥–æ –ø–∏—Ç–∞–Ω–∏—è, –∏ —è –ø—Ä–æ–≤–µ—Ä—é, "
        "—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ª–∏ –ø—Ä–æ–¥—É–∫—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º –í—Å–µ–º–∏—Ä–Ω–æ–π –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –ó–¥—Ä–∞–≤–æ–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.\n\n"
        "–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –ø—Ä–æ–¥—É–∫—Ç—ã –¥–ª—è –¥–µ—Ç–µ–π –æ—Ç 6 –¥–æ 36 –º–µ—Å—è—Ü–µ–≤.\n\n"
        "üì∏ –î–ª—è –∞–Ω–∞–ª–∏–∑–∞ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —á–µ—Ç–∫–æ–µ —Ñ–æ—Ç–æ —ç—Ç–∏–∫–µ—Ç–∫–∏ —Å —Ö–æ—Ä–æ—à–∏–º –æ—Å–≤–µ—â–µ–Ω–∏–µ–º.\n"
        "üîç –°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–≤–µ—Ä–∏—Ç —Å–æ—Å—Ç–∞–≤, –º–∞—Ä–∫–∏—Ä–æ–≤–∫—É –∏ –≤–æ–∑—Ä–∞—Å—Ç–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –Ω–µ–π—Ä–æ—Å–µ—Ç–∏ Qwen3."
    )
    bot.reply_to(message, welcome_message)


# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π
@bot.message_handler(content_types=['photo'])
def handle_photo(message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π"""
    try:
        # –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ñ–æ—Ç–æ (–±–µ—Ä–µ–º —Å–∞–º–æ–µ –±–æ–ª—å—à–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ)
        photo_file = bot.get_file(message.photo[-1].file_id)

        # –°–æ–∑–¥–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –ø—É—Ç–∏ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        image_path = f"temp_{message.message_id}.jpg"

        # –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–æ—Ç–æ
        downloaded_file = bot.download_file(photo_file.file_path)
        with open(image_path, 'wb') as new_file:
            new_file.write(downloaded_file)

        # –û—Ü–µ–Ω–∫–∞ –ø—Ä–æ–¥—É–∫—Ç–∞
        processing_msg = bot.reply_to(message, "üîç –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ. –ê–Ω–∞–ª–∏–∑ –º–æ–∂–µ—Ç –¥–ª–∏—Ç—Å—è –¥–æ 1 –º–∏–Ω—É—Ç—ã...")

        try:
            # –í—ã–ø–æ–ª–Ω—è–µ–º –æ—Ü–µ–Ω–∫—É —á–µ—Ä–µ–∑ Qwen3 API
            analysis = evaluator.evaluate_product(image_path)

            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É—Å—Ç–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            if not analysis or len(analysis.strip()) == 0:
                logger.error("–ü–æ–ª—É—á–µ–Ω –ø—É—Å—Ç–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä–∞")
                analysis = (
                    "‚ùå –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞: –ø–æ–ª—É—á–µ–Ω –ø—É—Å—Ç–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç.\n\n"
                    "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ:\n"
                    "1. –û—Ç–ø—Ä–∞–≤–∏—Ç—å –±–æ–ª–µ–µ —á–µ—Ç–∫–æ–µ —Ñ–æ—Ç–æ —ç—Ç–∏–∫–µ—Ç–∫–∏\n"
                    "2. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —Ç–µ–∫—Å—Ç –Ω–∞ —ç—Ç–∏–∫–µ—Ç–∫–µ —Ö–æ—Ä–æ—à–æ –≤–∏–¥–µ–Ω\n"
                    "3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Å–≤–µ—â–µ–Ω–∏–µ –Ω–∞ —Ñ–æ—Ç–æ"
                )

            # –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ "–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ"
            try:
                bot.delete_message(message.chat.id, processing_msg.message_id)
            except Exception as delete_error:
                logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ: {str(delete_error)}")

            # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π TXT-—Ñ–∞–π–ª
            txt_path = f"report_{message.message_id}.txt"
            with open(txt_path, 'w', encoding='utf-8') as txt_file:
                txt_file.write(analysis)

            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∞–π–ª
            with open(txt_path, 'rb') as txt_file:
                bot.send_document(
                    message.chat.id,
                    txt_file,
                    caption="üìÑ –†–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞ –¥–µ—Ç—Å–∫–æ–≥–æ –ø–∏—Ç–∞–Ω–∏—è"
                )

            # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π TXT-—Ñ–∞–π–ª
            if os.path.exists(txt_path):
                os.remove(txt_path)

        except Exception as eval_error:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ü–µ–Ω–∫–µ –ø—Ä–æ–¥—É–∫—Ç–∞: {str(eval_error)}")
            try:
                # –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ "–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ", –µ—Å–ª–∏ –æ–Ω–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
                try:
                    bot.delete_message(message.chat.id, processing_msg.message_id)
                except:
                    pass

                bot.send_message(message.chat.id, (
                    "‚ö†Ô∏è –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –ø—Ä–æ–¥—É–∫—Ç–∞.\n\n"
                    "–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:\n"
                    "- –°–ª–æ–∂–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —ç—Ç–∏–∫–µ—Ç–∫–∏\n"
                    "- –°–ª–∏—à–∫–æ–º –º–µ–ª–∫–∏–π —à—Ä–∏—Ñ—Ç\n"
                    "- –ù–∏–∑–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è\n\n"
                    "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –±–æ–ª–µ–µ —á–µ—Ç–∫–æ–µ —Ñ–æ—Ç–æ —ç—Ç–∏–∫–µ—Ç–∫–∏."
                ))
            except Exception as send_error:
                logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ: {str(send_error)}")

        # –£–¥–∞–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        if os.path.exists(image_path):
            os.remove(image_path)

    except Exception as e:
        logger.error(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏: {str(e)}")
        try:
            # –ü—ã—Ç–∞–µ–º—Å—è —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ "–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ", –µ—Å–ª–∏ –æ–Ω–æ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            if 'processing_msg' in locals():
                try:
                    bot.delete_message(message.chat.id, processing_msg.message_id)
                except:
                    pass

            bot.reply_to(message, (
                "‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.\n\n"
                "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ:\n"
                "1. –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ –≤ –ª—É—á—à–µ–º –∫–∞—á–µ—Å—Ç–≤–µ\n"
                "2. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —ç—Ç–∏–∫–µ—Ç–∫–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤–∏–¥–Ω–∞\n"
                "3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Å–≤–µ—â–µ–Ω–∏–µ –Ω–∞ —Ñ–æ—Ç–æ\n\n"
                "–ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è, —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º."
            ))
        except Exception as reply_error:
            logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ: {str(reply_error)}")


# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
@bot.message_handler(func=lambda message: True)
def handle_other_messages(message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π"""
    response = (
        "–Ø –º–æ–≥—É –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ —ç—Ç–∏–∫–µ—Ç–æ–∫ –¥–µ—Ç—Å–∫–æ–≥–æ –ø–∏—Ç–∞–Ω–∏—è.\n\n"
        "üì∏ –ß—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç:\n"
        "1. –°—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä—É–π—Ç–µ —ç—Ç–∏–∫–µ—Ç–∫—É –ø—Ä–æ–¥—É–∫—Ç–∞\n"
        "2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ç–µ–∫—Å—Ç —Ö–æ—Ä–æ—à–æ –≤–∏–¥–µ–Ω\n"
        "3. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ –≤ —ç—Ç–æ—Ç —á–∞—Ç\n\n"
        "–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –ø—Ä–æ–¥—É–∫—Ç—ã –¥–ª—è –¥–µ—Ç–µ–π –æ—Ç 6 –¥–æ 36 –º–µ—Å—è—Ü–µ–≤."
    )
    bot.reply_to(message, response)


def main():
    """–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞"""
    logger.info("–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º telebot...")

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Ñ–∞–π–ª–∞ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π
    if not os.path.exists('–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è_–ø–æ_–æ—Ü–µ–Ω–∫–µ_–ø—Ä–æ–¥—É–∫—Ç–∞_–ø–∏—Ç–∞–Ω–∏—è.doc'):
        logger.error("–§–∞–π–ª —Å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º–∏ –í–û–ó –Ω–µ –Ω–∞–π–¥–µ–Ω!")
        logger.info(
            "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–º–µ—Å—Ç–∏—Ç–µ —Ñ–∞–π–ª '–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è_–ø–æ_–æ—Ü–µ–Ω–∫–µ_–ø—Ä–æ–¥—É–∫—Ç–∞_–ø–∏—Ç–∞–Ω–∏—è.doc' –≤ –∫–æ—Ä–Ω–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞.")

    # –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
    logger.info("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ")
    bot.polling(none_stop=True)


if __name__ == "__main__":
    main()
